

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Amplitude Perturbation Visualization &mdash; Braindecode 0.1.6 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Braindecode 0.1.6 documentation" href="../../index.html"/>
        <link rel="next" title="braindecode.datautil package" href="../../source/braindecode.datautil.html"/>
        <link rel="prev" title="Using the Experiment Class" href="../Experiment_Class.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Braindecode
          

          
          </a>

          
            
            
              <div class="version">
                0.1.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../TrialWise_Decoding.html">Trialwise Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Cropped_Decoding.html">Cropped Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Experiment_Class.html">Using the Experiment Class</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Amplitude Perturbation Visualization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Load-data">Load data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Create-the-model,-optimizer,-iterator">Create the model, optimizer, iterator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Training-loop">Training loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Compute-correlation:-amplitude-perturbation---prediction-change">Compute correlation: amplitude perturbation - prediction change</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plot-correlations">Plot correlations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Plot-with-MNE">Plot with MNE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Plot-with-Braindecode">Plot with Braindecode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Dataset-References">Dataset References</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/braindecode.datautil.html">braindecode.datautil package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/braindecode.experiments.html">braindecode.experiments package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/braindecode.mne_ext.html">braindecode.mne_ext package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/braindecode.models.html">braindecode.models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/braindecode.torch_ext.html">braindecode.torch_ext package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Braindecode</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Amplitude Perturbation Visualization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/visualization/Perturbation.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Amplitude-Perturbation-Visualization">
<h1>Amplitude Perturbation Visualization<a class="headerlink" href="#Amplitude-Perturbation-Visualization" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we show how to use perturbations of the input
amplitudes to learn something about the trained convolutional networks.
For more background, see <a class="reference external" href="https://arxiv.org/abs/1703.05051">Deep learning with convolutional neural
networks for EEG decoding and
visualization</a>, Section A.5.2.</p>
<p>First we will do some cross-subject decoding, again using the
<a class="reference external" href="https://www.physionet.org/physiobank/database/eegmmidb/">Physiobank EEG Motor Movement/Imagery
Dataset</a>,
this time to decode imagined left hand vs. imagined right hand movement.</p>
<div class="admonition warning">
This tutorial might be very slow if you are not using a GPU.</div>
<div class="section" id="Load-data">
<h2>Load data<a class="headerlink" href="#Load-data" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">capture</span>
import mne
import numpy as np
from mne.io import concatenate_raws
from braindecode.datautil.signal_target import SignalAndTarget

# First 50 subjects as train
physionet_paths = [ mne.datasets.eegbci.load_data(sub_id,[4,8,12,]) for sub_id in range(1,51)]
physionet_paths = np.concatenate(physionet_paths)
parts = [mne.io.read_raw_edf(path, preload=True,stim_channel=&#39;auto&#39;)
         for path in physionet_paths]

raw = concatenate_raws(parts)

picks = mne.pick_types(raw.info, meg=False, eeg=True, stim=False, eog=False,
                   exclude=&#39;bads&#39;)

events = mne.find_events(raw, shortest_event=0, stim_channel=&#39;STI 014&#39;)

# Read epochs (train will be done only between 1 and 2s)
# Testing will be done with a running classifier
epoched = mne.Epochs(raw, events, dict(hands=2, feet=3), tmin=1, tmax=4.1, proj=False, picks=picks,
                baseline=None, preload=True)

# Next 5 subjects as test
physionet_paths_test = [mne.datasets.eegbci.load_data(sub_id,[4,8,12,]) for sub_id in range(51,56)]
physionet_paths_test = np.concatenate(physionet_paths_test)
parts_test = [mne.io.read_raw_edf(path, preload=True,stim_channel=&#39;auto&#39;)
         for path in physionet_paths_test]
raw_test = concatenate_raws(parts_test)

picks_test = mne.pick_types(raw_test.info, meg=False, eeg=True, stim=False, eog=False,
                   exclude=&#39;bads&#39;)

events_test = mne.find_events(raw_test, shortest_event=0, stim_channel=&#39;STI 014&#39;)

# Read epochs (train will be done only between 1 and 2s)
# Testing will be done with a running classifier
epoched_test = mne.Epochs(raw_test, events_test, dict(hands=2, feet=3), tmin=1, tmax=4.1, proj=False, picks=picks_test,
                baseline=None, preload=True)

train_X = (epoched.get_data() * 1e6).astype(np.float32)
train_y = (epoched.events[:,2] - 2).astype(np.int64) #2,3 -&gt; 0,1
test_X = (epoched_test.get_data() * 1e6).astype(np.float32)
test_y = (epoched_test.events[:,2] - 2).astype(np.int64) #2,3 -&gt; 0,1
train_set = SignalAndTarget(train_X, y=train_y)
test_set = SignalAndTarget(test_X, y=test_y)
</pre></div>
</div>
</div>
</div>
<div class="section" id="Create-the-model,-optimizer,-iterator">
<h2>Create the model, optimizer, iterator<a class="headerlink" href="#Create-the-model,-optimizer,-iterator" title="Permalink to this headline">¶</a></h2>
<p>We use the deep ConvNet from <a class="reference external" href="https://arxiv.org/abs/1703.05051">Deep learning with convolutional neural
networks for EEG decoding and
visualization</a> (Section 2.4.2).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">braindecode.models.deep4</span> <span class="k">import</span> <span class="n">Deep4Net</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="k">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">braindecode.torch_ext.util</span> <span class="k">import</span> <span class="n">set_random_seeds</span>
<span class="kn">from</span> <span class="nn">braindecode.models.util</span> <span class="k">import</span> <span class="n">to_dense_prediction_model</span>

<span class="c1"># Set if you want to use GPU</span>
<span class="c1"># You can also use torch.cuda.is_available() to determine if cuda is available on your machine.</span>
<span class="n">cuda</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">set_random_seeds</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">20170629</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="n">cuda</span><span class="p">)</span>

<span class="c1"># This will determine how many crops are processed in parallel</span>
<span class="n">input_time_length</span> <span class="o">=</span> <span class="mi">450</span>
<span class="c1"># final_conv_length determines the size of the receptive field of the ConvNet</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Deep4Net</span><span class="p">(</span><span class="n">in_chans</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_time_length</span><span class="o">=</span><span class="n">input_time_length</span><span class="p">,</span>
                 <span class="n">filter_length_3</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">filter_length_4</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">pool_time_stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">final_conv_length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">create_network</span><span class="p">()</span>
<span class="n">to_dense_prediction_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">torch</span> <span class="k">import</span> <span class="n">optim</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">braindecode.torch_ext.util</span> <span class="k">import</span> <span class="n">np_to_var</span>
<span class="c1"># determine output size</span>
<span class="n">test_input</span> <span class="o">=</span> <span class="n">np_to_var</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">input_time_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
    <span class="n">test_input</span> <span class="o">=</span> <span class="n">test_input</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
<span class="n">n_preds_per_input</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2"> predictions per input/trial&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_preds_per_input</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">braindecode.datautil.iterators</span> <span class="k">import</span> <span class="n">CropsFromTrialsIterator</span>
<span class="n">iterator</span> <span class="o">=</span> <span class="n">CropsFromTrialsIterator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">input_time_length</span><span class="o">=</span><span class="n">input_time_length</span><span class="p">,</span>
                                  <span class="n">n_preds_per_input</span><span class="o">=</span><span class="n">n_preds_per_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
315 predictions per input/trial
</pre></div></div>
</div>
</div>
<div class="section" id="Training-loop">
<h2>Training loop<a class="headerlink" href="#Training-loop" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">braindecode.torch_ext.util</span> <span class="k">import</span> <span class="n">np_to_var</span><span class="p">,</span> <span class="n">var_to_np</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">RandomState</span>
<span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">th</span>
<span class="kn">from</span> <span class="nn">braindecode.experiments.monitors</span> <span class="k">import</span> <span class="n">compute_preds_per_trial_for_set</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">((</span><span class="mi">2017</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">30</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_epoch</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train....&quot;</span><span class="p">)</span>
    <span class="c1"># Set model to training mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch_X</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">iterator</span><span class="o">.</span><span class="n">get_batches</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">net_in</span> <span class="o">=</span> <span class="n">np_to_var</span><span class="p">(</span><span class="n">batch_X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
            <span class="n">net_in</span> <span class="o">=</span> <span class="n">net_in</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">net_target</span> <span class="o">=</span> <span class="n">np_to_var</span><span class="p">(</span><span class="n">batch_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
            <span class="n">net_target</span> <span class="o">=</span> <span class="n">net_target</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="c1"># Remove gradients of last backward pass from all parameters</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">net_in</span><span class="p">)</span>
        <span class="c1"># Mean predictions across trial</span>
        <span class="c1"># Note that this will give identical gradients to computing</span>
        <span class="c1"># a per-prediction loss (at least for the combination of log softmax activation</span>
        <span class="c1"># and negative log likelihood loss which we are using here)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">net_target</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># Print some statistics each epoch</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">setname</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;Train&#39;</span><span class="p">,</span> <span class="n">train_set</span><span class="p">),(</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">test_set</span><span class="p">)):</span>
        <span class="c1"># Collect all predictions and losses</span>
        <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">batch_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_X</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">iterator</span><span class="o">.</span><span class="n">get_batches</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">net_in</span> <span class="o">=</span> <span class="n">np_to_var</span><span class="p">(</span><span class="n">batch_X</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
                <span class="n">net_in</span> <span class="o">=</span> <span class="n">net_in</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">net_target</span> <span class="o">=</span> <span class="n">np_to_var</span><span class="p">(</span><span class="n">batch_y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
                <span class="n">net_target</span> <span class="o">=</span> <span class="n">net_target</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">net_in</span><span class="p">)</span>
            <span class="n">all_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_to_np</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">net_target</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">var_to_np</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
            <span class="n">all_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">batch_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_X</span><span class="p">))</span>
        <span class="c1"># Compute mean per-input loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_losses</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">)</span> <span class="o">/</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:6s}</span><span class="s2"> Loss: </span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">setname</span><span class="p">,</span> <span class="n">loss</span><span class="p">))</span>
        <span class="n">preds_per_trial</span> <span class="o">=</span> <span class="n">compute_preds_per_trial_for_set</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span>
                                                          <span class="n">input_time_length</span><span class="p">,</span>
                                                          <span class="n">dataset</span><span class="p">)</span>
        <span class="c1"># preds per trial are now trials x classes x timesteps/predictions</span>
        <span class="c1"># Now mean across timesteps for each trial to get per-trial predictions</span>
        <span class="n">meaned_preds_per_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">preds_per_trial</span><span class="p">])</span>
        <span class="n">predicted_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">meaned_preds_per_trial</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predicted_labels</span> <span class="o">==</span> <span class="n">dataset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:6s}</span><span class="s2"> Accuracy: </span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">setname</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Epoch 0
Train....
Train  Loss: 0.71869
Train  Accuracy: 52.8%
Test   Loss: 0.71858
Test   Accuracy: 50.2%
Epoch 1
Train....
Train  Loss: 0.66870
Train  Accuracy: 61.6%
Test   Loss: 0.63981
Test   Accuracy: 64.3%
Epoch 2
Train....
Train  Loss: 0.63789
Train  Accuracy: 68.7%
Test   Loss: 0.58520
Test   Accuracy: 79.3%
Epoch 3
Train....
Train  Loss: 0.63376
Train  Accuracy: 70.2%
Test   Loss: 0.57499
Test   Accuracy: 85.4%
Epoch 4
Train....
Train  Loss: 0.63206
Train  Accuracy: 70.4%
Test   Loss: 0.57617
Test   Accuracy: 85.0%
Epoch 5
Train....
Train  Loss: 0.62972
Train  Accuracy: 69.9%
Test   Loss: 0.56490
Test   Accuracy: 87.8%
Epoch 6
Train....
Train  Loss: 0.62937
Train  Accuracy: 68.8%
Test   Loss: 0.55145
Test   Accuracy: 85.0%
Epoch 7
Train....
Train  Loss: 0.62180
Train  Accuracy: 70.7%
Test   Loss: 0.54012
Test   Accuracy: 87.8%
Epoch 8
Train....
Train  Loss: 0.62625
Train  Accuracy: 71.0%
Test   Loss: 0.53656
Test   Accuracy: 88.7%
Epoch 9
Train....
Train  Loss: 0.63245
Train  Accuracy: 68.6%
Test   Loss: 0.53936
Test   Accuracy: 83.6%
Epoch 10
Train....
Train  Loss: 0.62556
Train  Accuracy: 69.8%
Test   Loss: 0.53812
Test   Accuracy: 87.3%
Epoch 11
Train....
Train  Loss: 0.63556
Train  Accuracy: 68.4%
Test   Loss: 0.52986
Test   Accuracy: 83.6%
Epoch 12
Train....
Train  Loss: 0.64142
Train  Accuracy: 67.5%
Test   Loss: 0.53861
Test   Accuracy: 80.3%
Epoch 13
Train....
Train  Loss: 0.63586
Train  Accuracy: 68.6%
Test   Loss: 0.53492
Test   Accuracy: 82.2%
Epoch 14
Train....
Train  Loss: 0.64711
Train  Accuracy: 67.8%
Test   Loss: 0.54978
Test   Accuracy: 79.8%
Epoch 15
Train....
Train  Loss: 0.63821
Train  Accuracy: 68.6%
Test   Loss: 0.54260
Test   Accuracy: 78.9%
Epoch 16
Train....
Train  Loss: 0.63897
Train  Accuracy: 67.2%
Test   Loss: 0.55117
Test   Accuracy: 74.6%
Epoch 17
Train....
Train  Loss: 0.64410
Train  Accuracy: 66.8%
Test   Loss: 0.55882
Test   Accuracy: 73.2%
Epoch 18
Train....
Train  Loss: 0.63305
Train  Accuracy: 67.6%
Test   Loss: 0.54308
Test   Accuracy: 77.9%
Epoch 19
Train....
Train  Loss: 0.64199
Train  Accuracy: 66.0%
Test   Loss: 0.56335
Test   Accuracy: 71.8%
</pre></div></div>
</div>
</div>
<div class="section" id="Compute-correlation:-amplitude-perturbation---prediction-change">
<h2>Compute correlation: amplitude perturbation - prediction change<a class="headerlink" href="#Compute-correlation:-amplitude-perturbation---prediction-change" title="Permalink to this headline">¶</a></h2>
<p>First collect all batches and concatenate them into one array of
examples:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">train_batches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterator</span><span class="o">.</span><span class="n">get_batches</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">train_X_batches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">train_batches</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Next, create a prediction function that that wraps the model prediction
function and returns the predictions as numpy arrays.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span>
<span class="n">pred_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">var_to_np</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">np_to_var</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Setup logging and compute the correlations between amplitude
perturbations and prediction changes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">braindecode.visualization.perturbation</span> <span class="k">import</span> <span class="n">compute_amplitude_prediction_correlations</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> : </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                     <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="n">amp_pred_corrs</span> <span class="o">=</span> <span class="n">compute_amplitude_prediction_correlations</span><span class="p">(</span><span class="n">pred_fn</span><span class="p">,</span> <span class="n">train_X_batches</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                         <span class="n">batch_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2017-07-10 13:23:31,520 INFO : Compute original predictions...
2017-07-10 13:23:44,636 INFO : Iteration 0...
2017-07-10 13:23:44,637 INFO : Sample perturbation...
2017-07-10 13:23:48,207 INFO : Compute new amplitudes...
2017-07-10 13:23:48,797 INFO : Compute new  complex inputs...
2017-07-10 13:23:55,029 INFO : Compute new real inputs...
2017-07-10 13:23:58,109 INFO : Compute new predictions...
2017-07-10 13:23:59,129 INFO : Compute correlation...
2017-07-10 13:23:59,932 INFO : Iteration 1...
2017-07-10 13:23:59,933 INFO : Sample perturbation...
2017-07-10 13:24:03,503 INFO : Compute new amplitudes...
2017-07-10 13:24:04,095 INFO : Compute new  complex inputs...
2017-07-10 13:24:10,336 INFO : Compute new real inputs...
2017-07-10 13:24:13,423 INFO : Compute new predictions...
2017-07-10 13:24:14,417 INFO : Compute correlation...
2017-07-10 13:24:15,220 INFO : Iteration 2...
2017-07-10 13:24:15,220 INFO : Sample perturbation...
2017-07-10 13:24:18,793 INFO : Compute new amplitudes...
2017-07-10 13:24:19,382 INFO : Compute new  complex inputs...
2017-07-10 13:24:25,609 INFO : Compute new real inputs...
2017-07-10 13:24:28,685 INFO : Compute new predictions...
2017-07-10 13:24:29,679 INFO : Compute correlation...
2017-07-10 13:24:30,482 INFO : Iteration 3...
2017-07-10 13:24:30,483 INFO : Sample perturbation...
2017-07-10 13:24:34,054 INFO : Compute new amplitudes...
2017-07-10 13:24:34,644 INFO : Compute new  complex inputs...
2017-07-10 13:24:40,870 INFO : Compute new real inputs...
2017-07-10 13:24:43,946 INFO : Compute new predictions...
2017-07-10 13:24:44,955 INFO : Compute correlation...
2017-07-10 13:24:45,758 INFO : Iteration 4...
2017-07-10 13:24:45,759 INFO : Sample perturbation...
2017-07-10 13:24:49,331 INFO : Compute new amplitudes...
2017-07-10 13:24:49,920 INFO : Compute new  complex inputs...
2017-07-10 13:24:56,156 INFO : Compute new real inputs...
2017-07-10 13:24:59,236 INFO : Compute new predictions...
2017-07-10 13:25:00,230 INFO : Compute correlation...
2017-07-10 13:25:01,033 INFO : Iteration 5...
2017-07-10 13:25:01,034 INFO : Sample perturbation...
2017-07-10 13:25:04,605 INFO : Compute new amplitudes...
2017-07-10 13:25:05,194 INFO : Compute new  complex inputs...
2017-07-10 13:25:11,422 INFO : Compute new real inputs...
2017-07-10 13:25:14,499 INFO : Compute new predictions...
2017-07-10 13:25:15,492 INFO : Compute correlation...
2017-07-10 13:25:16,296 INFO : Iteration 6...
2017-07-10 13:25:16,297 INFO : Sample perturbation...
2017-07-10 13:25:19,868 INFO : Compute new amplitudes...
2017-07-10 13:25:20,457 INFO : Compute new  complex inputs...
2017-07-10 13:25:26,687 INFO : Compute new real inputs...
2017-07-10 13:25:29,768 INFO : Compute new predictions...
2017-07-10 13:25:30,788 INFO : Compute correlation...
2017-07-10 13:25:31,592 INFO : Iteration 7...
2017-07-10 13:25:31,593 INFO : Sample perturbation...
2017-07-10 13:25:35,165 INFO : Compute new amplitudes...
2017-07-10 13:25:35,753 INFO : Compute new  complex inputs...
2017-07-10 13:25:41,989 INFO : Compute new real inputs...
2017-07-10 13:25:45,065 INFO : Compute new predictions...
2017-07-10 13:25:46,059 INFO : Compute correlation...
2017-07-10 13:25:46,863 INFO : Iteration 8...
2017-07-10 13:25:46,864 INFO : Sample perturbation...
2017-07-10 13:25:50,434 INFO : Compute new amplitudes...
2017-07-10 13:25:51,023 INFO : Compute new  complex inputs...
2017-07-10 13:25:57,256 INFO : Compute new real inputs...
2017-07-10 13:26:00,337 INFO : Compute new predictions...
2017-07-10 13:26:01,332 INFO : Compute correlation...
2017-07-10 13:26:02,135 INFO : Iteration 9...
2017-07-10 13:26:02,136 INFO : Sample perturbation...
2017-07-10 13:26:05,709 INFO : Compute new amplitudes...
2017-07-10 13:26:06,300 INFO : Compute new  complex inputs...
2017-07-10 13:26:12,527 INFO : Compute new real inputs...
2017-07-10 13:26:15,606 INFO : Compute new predictions...
2017-07-10 13:26:16,619 INFO : Compute correlation...
2017-07-10 13:26:17,422 INFO : Iteration 10...
2017-07-10 13:26:17,422 INFO : Sample perturbation...
2017-07-10 13:26:20,994 INFO : Compute new amplitudes...
2017-07-10 13:26:21,585 INFO : Compute new  complex inputs...
2017-07-10 13:26:27,823 INFO : Compute new real inputs...
2017-07-10 13:26:30,907 INFO : Compute new predictions...
2017-07-10 13:26:31,902 INFO : Compute correlation...
2017-07-10 13:26:32,705 INFO : Iteration 11...
2017-07-10 13:26:32,706 INFO : Sample perturbation...
2017-07-10 13:26:36,278 INFO : Compute new amplitudes...
2017-07-10 13:26:36,870 INFO : Compute new  complex inputs...
2017-07-10 13:26:43,103 INFO : Compute new real inputs...
2017-07-10 13:26:46,186 INFO : Compute new predictions...
2017-07-10 13:26:47,184 INFO : Compute correlation...
</pre></div></div>
</div>
</div>
<div class="section" id="Plot-correlations">
<h2>Plot correlations<a class="headerlink" href="#Plot-correlations" title="Permalink to this headline">¶</a></h2>
<p>Compute the mean correlations across iterations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">mean_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp_pred_corrs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Pick out one frequency range and mean correlations within that frequency
range to make a scalp plot. Here we use the alpha frequency range.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>

<span></span><span class="n">fs</span> <span class="o">=</span> <span class="n">epoched</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]</span>
<span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">train_X_batches</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">start_freq</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">stop_freq</span> <span class="o">=</span> <span class="mi">14</span>

<span class="n">i_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span><span class="n">start_freq</span><span class="p">)</span>
<span class="n">i_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">stop_freq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">freq_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mean_corr</span><span class="p">[:,</span><span class="n">i_start</span><span class="p">:</span><span class="n">i_stop</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now get approximate positions of the channels in the 10-20 system.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">braindecode.datasets.sensor_positions</span> <span class="k">import</span> <span class="n">get_channelpos</span><span class="p">,</span> <span class="n">CHANNEL_10_20_APPROX</span>

<span class="n">ch_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">epoched</span><span class="o">.</span><span class="n">ch_names</span><span class="p">]</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_channelpos</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">CHANNEL_10_20_APPROX</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ch_names</span><span class="p">]</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Plot-with-MNE">
<h3>Plot with MNE<a class="headerlink" href="#Plot-with-MNE" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">max_abs_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freq_corr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Left Hand&#39;</span><span class="p">,</span> <span class="s1">&#39;Right Hand&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_class</span><span class="p">]</span>
    <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_topomap</span><span class="p">(</span><span class="n">freq_corr</span><span class="p">[:,</span><span class="n">i_class</span><span class="p">],</span> <span class="n">positions</span><span class="p">,</span>
                     <span class="n">vmin</span><span class="o">=-</span><span class="n">max_abs_val</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_abs_val</span><span class="p">,</span> <span class="n">contours</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">i_class</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_visualization_Perturbation_26_0.png" src="../../_images/notebooks_visualization_Perturbation_26_0.png" />
</div>
</div>
</div>
<div class="section" id="Plot-with-Braindecode">
<h3>Plot with Braindecode<a class="headerlink" href="#Plot-with-Braindecode" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">braindecode.visualization.plot</span> <span class="k">import</span> <span class="n">ax_scalp</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Left Hand&#39;</span><span class="p">,</span> <span class="s1">&#39;Right Hand&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i_class</span><span class="p">]</span>
    <span class="n">ax_scalp</span><span class="p">(</span><span class="n">freq_corr</span><span class="p">[:,</span><span class="n">i_class</span><span class="p">],</span> <span class="n">ch_names</span><span class="p">,</span> <span class="n">chan_pos_list</span><span class="o">=</span><span class="n">CHANNEL_10_20_APPROX</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=-</span><span class="n">max_abs_val</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_abs_val</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">class_names</span><span class="p">[</span><span class="n">i_class</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_visualization_Perturbation_28_0.png" src="../../_images/notebooks_visualization_Perturbation_28_0.png" />
</div>
</div>
<p>From these plots we can see the ConvNet clearly learned to use the
lateralized response in the alpha band. Note that the positive
correlations for the left hand on the left side do not imply an increase
of alpha activity for the left hand in the data, see <a class="reference external" href="https://arxiv.org/abs/1703.05051">Deep learning with
convolutional neural networks for EEG decoding and
visualization</a> Result 12 for some
notes on interpretability.</p>
</div>
</div>
<div class="section" id="Dataset-References">
<h2>Dataset References<a class="headerlink" href="#Dataset-References" title="Permalink to this headline">¶</a></h2>
<p>This dataset was created and contributed to PhysioNet by the developers
of the <a class="reference external" href="http://www.schalklab.org/research/bci2000">BCI2000</a>
instrumentation system, which they used in making these recordings. The
system is described in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Schalk</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="p">,</span> <span class="n">McFarland</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">J</span><span class="o">.</span><span class="p">,</span> <span class="n">Hinterberger</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="p">,</span> <span class="n">Birbaumer</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="p">,</span> <span class="n">Wolpaw</span><span class="p">,</span> <span class="n">J</span><span class="o">.</span><span class="n">R</span><span class="o">.</span> <span class="p">(</span><span class="mi">2004</span><span class="p">)</span> <span class="n">BCI2000</span><span class="p">:</span> <span class="n">A</span> <span class="n">General</span><span class="o">-</span><span class="n">Purpose</span> <span class="n">Brain</span><span class="o">-</span><span class="n">Computer</span> <span class="n">Interface</span> <span class="p">(</span><span class="n">BCI</span><span class="p">)</span> <span class="n">System</span><span class="o">.</span> <span class="n">IEEE</span> <span class="n">TBME</span> <span class="mi">51</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="mi">1034</span><span class="o">-</span><span class="mf">1043.</span>
</pre></div>
</div>
<p><a class="reference external" href="https://physionet.org/physiobank/">PhysioBank</a> is a large and
growing archive of well-characterized digital recordings of physiologic
signals and related data for use by the biomedical research community
and further described in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Goldberger</span> <span class="n">AL</span><span class="p">,</span> <span class="n">Amaral</span> <span class="n">LAN</span><span class="p">,</span> <span class="n">Glass</span> <span class="n">L</span><span class="p">,</span> <span class="n">Hausdorff</span> <span class="n">JM</span><span class="p">,</span> <span class="n">Ivanov</span> <span class="n">PCh</span><span class="p">,</span> <span class="n">Mark</span> <span class="n">RG</span><span class="p">,</span> <span class="n">Mietus</span> <span class="n">JE</span><span class="p">,</span> <span class="n">Moody</span> <span class="n">GB</span><span class="p">,</span> <span class="n">Peng</span> <span class="n">C</span><span class="o">-</span><span class="n">K</span><span class="p">,</span> <span class="n">Stanley</span> <span class="n">HE</span><span class="o">.</span> <span class="p">(</span><span class="mi">2000</span><span class="p">)</span> <span class="n">PhysioBank</span><span class="p">,</span> <span class="n">PhysioToolkit</span><span class="p">,</span> <span class="ow">and</span> <span class="n">PhysioNet</span><span class="p">:</span> <span class="n">Components</span> <span class="n">of</span> <span class="n">a</span> <span class="n">New</span> <span class="n">Research</span> <span class="n">Resource</span> <span class="k">for</span> <span class="n">Complex</span> <span class="n">Physiologic</span> <span class="n">Signals</span><span class="o">.</span> <span class="n">Circulation</span> <span class="mi">101</span><span class="p">(</span><span class="mi">23</span><span class="p">):</span><span class="n">e215</span><span class="o">-</span><span class="n">e220</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../source/braindecode.datautil.html" class="btn btn-neutral float-right" title="braindecode.datautil package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../Experiment_Class.html" class="btn btn-neutral" title="Using the Experiment Class" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Robin Tibor Schirrmeister.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.6',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>